{% extends 'base.html' %}
{% block content %}
<form method="post">{% csrf_token %}
<!-- Invoice Header -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Invoice Header</div>
                    <div class="panel-subtitle">Main invoice information & client selection</div>
                </div>
                <div class="panel-body">
                    <div class="form-grid">
                        <!-- ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                        <div class="field-group">
                            <label for="invoice-no">Invoice No.</label>
                            <input id="invoice-no" type="text" placeholder="e.g. 02234" name="invoice_no">
                        </div>

                        <!-- ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© -->
                        <div class="field-group">
                            <label for="invoice-date">Date</label>
                            <input id="invoice-date" type="date" name="date">
                        </div>

                        <!-- ÿ±ŸÇŸÖ ÿ£ŸÖÿ± ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ -->
                        <div class="field-group">
                            <label for="operation-order">Operation Order No.</label>
                            <input id="operation-order" type="text" placeholder="e.g. OP/2025/123" name="operation_order_no">
                        </div>

                        <!-- ŸÉŸàÿØ ÿßŸÑÿ≤ÿ®ŸàŸÜ -->
                        <div class="field-group">
                            <label for="customer-no">Customer Code</label>
                            <input id="customer-no" type="text" placeholder="e.g. 00007" name="customer_code">
                        </div>

                        <!-- ÿßÿ≥ŸÖ ÿßŸÑÿ≤ÿ®ŸàŸÜ / ÿßŸÑÿ®ŸÑÿØŸäÿ© -->
                        <div class="field-group">
                            <label for="customer-select">Client / Municipality</label>
                            <select id="customer-select" name="customer_select">
                                <option value="">Select customer‚Ä¶</option>
                                <option value="bahla-muni">Daerah Municipality Bahla</option>
                                <option value="manah-muni">Daerah Municipality Manah</option>
                                <option value="adam-muni">Daerah Municipality Adam</option>
                                <option value="other">Other client‚Ä¶</option>
                            </select>
                        </div>

                        <!-- ÿ±ŸÖÿ≤ ÿßŸÑŸàŸÑÿßŸäÿ© -->
                        <div class="field-group">
                            <label for="wilaya-code">Wilaya Code</label>
                            <input id="wilaya-code" type="text" placeholder="e.g. Al Dakhiliyah" name="wilaya_code">
                        </div>

                        <!-- ŸÖŸàŸÇÿπ ÿßŸÑÿπŸÖŸÑ -->
                        <div class="field-group">
                            <label for="location">Location / Site</label>
                            <input id="location" type="text" placeholder="e.g. Behind Al-Nahdha School" name="location_site">
                        </div>

                        <!-- ÿ≤ÿ± ÿ•ÿ∂ÿßŸÅÿ© ÿ≤ÿ®ŸàŸÜ ÿ¨ÿØŸäÿØ -->
                        <div class="field-group">
                            <label>&nbsp;</label>
                            <button class="btn-secondary full-width">+ Add new customer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add New Customer -->
            <div class="panel no-print">
                <div class="panel-header">
                    <div class="panel-title">Add New Customer</div>
                    <div class="panel-subtitle">Register a new municipality / client with its code</div>
                </div>
                <div class="panel-body">
                    <div class="form-grid-3">
                        <div class="field-group">
                            <label for="new-cust-name">Customer Name</label>
                            <input id="new-cust-name" type="text" placeholder="e.g. Municipality of Izki" />
                        </div>

                        <div class="field-group">
                            <label for="new-cust-code">Customer Code</label>
                            <input id="new-cust-code" type="text" placeholder="e.g. 00008" />
                        </div>

                        <div class="field-group">
                            <label for="new-cust-wilaya">Wilaya</label>
                            <input id="new-cust-wilaya" type="text" placeholder="e.g. Al Dakhiliyah" />
                        </div>

                        <div class="field-group">
                            <label for="new-cust-address">Address / Location</label>
                            <input id="new-cust-address" type="text" placeholder="Short address" />
                        </div>

                        <div class="field-group">
                            <label for="new-cust-contact">Contact Person</label>
                            <input id="new-cust-contact" type="text" placeholder="e.g. Eng. Ali Saleh" />
                        </div>

                        <div class="field-group">
                            <label>&nbsp;</label>
                            <button class="btn-primary full-width">Save Customer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Items (Linked to Warehouse) -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">Invoice Items</div>
                    <div class="panel-subtitle">
                        Select items from warehouse. For cable items, price is per meter and total is calculated automatically.
                    </div>
                </div>

                <div class="panel-body table-wrapper">
                    <table class="data-table" id="invoice-items-table">
                        <thead>
                        <tr>
                            <th>No.</th>
                            <th>Item from Warehouse</th>
                            <th>Item Code</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Amount</th>
                        </tr>
                        </thead>
                        <tbody>
                        <!-- Row 1 -->
                        <tr>
                            <td>1</td>
                            <td>
                                <select class="item-select" name="warehouse_code">
                                    <option value="">Select item‚Ä¶</option>
                                    {% for it in warehouse_items %}
                                    <option value="{{ it.code }}">{{ it.code }} - {{ it.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="text" class="item-code" name="item_code"></td>
                            <td><input type="text" class="item-desc" name="description"></td>
                            <td><input type="number" class="item-qty" value="1" min="0" step="0.001" name="quantity"></td>
                            <td><input type="text" class="item-unit" name="unit"></td>
                            <td><input type="number" class="item-price" value="0" step="0.001" name="unit_price"></td>
                            <td><span class="item-amount">0.000</span></td>
                        </tr>

                        <!-- Row 2 -->
                        <tr>
                            <td>2</td>
                            <td>
                                <select class="item-select" name="warehouse_code">
                                    <option value="">Select item‚Ä¶</option>
                                    {% for it in warehouse_items %}
                                    <option value="{{ it.code }}">{{ it.code }} - {{ it.name }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td><input type="text" class="item-code" name="item_code"></td>
                            <td><input type="text" class="item-desc" name="description"></td>
                            <td><input type="number" class="item-qty" value="1" min="0" step="0.001" name="quantity"></td>
                            <td><input type="text" class="item-unit" name="unit"></td>
                            <td><input type="number" class="item-price" value="0" step="0.001" name="unit_price"></td>
                            <td><span class="item-amount">0.000</span></td>
                        </tr>
                        </tbody>
                    </table>
                </div>

<div class="toolbar" style="margin-top: 0.75rem;">
    <div class="toolbar-left"></div>
    <div class="toolbar-right">
        <button class="btn-primary" type="button" id="add-item-row">+ Add Item</button>
    </div>
</div>

                <!-- Totals & Print Button -->
                <div class="invoice-totals">
                    <div class="totals-right">
                        <div class="totals-row">
                            <span>Subtotal</span>
                            <span id="subtotal-value">0.000</span>
                        </div>
                        <div class="totals-row">
                            <span>VAT (5%)</span>
                            <span id="vat-value">0.000</span>
                        </div>
                        <div class="totals-row totals-main">
                            <span>Total (Incl. VAT)</span>
                            <span id="total-value">0.000</span>
                        </div>
                        <button class="btn-primary" onclick="printInvoice()">üñ® Print Invoice</button>
<button class="btn-primary" type="submit" style="margin-top:10px;">üíæ Save Invoice</button>
                    </div>
                </div>
            </div>

            <!-- Printed by footer (visible only in print) -->
            <div id="print-footer" style="
                text-align: center;
                font-size: 0.75rem;
                color: #6b7280;
                margin-top: 2rem;
                display: none;
            ">
                ÿ∑ÿ®ÿπÿ™ ÿ®Ÿàÿßÿ≥ÿ∑ÿ©: <span id="printedBy"></span>
            </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Warehouse items as if stored in DB
    const warehouseItems = {{ warehouse_items_json|safe }};

    function format3(value) {
        return value.toFixed(3);
    }

    function recalcRow(row) {
        const qtyInput = row.querySelector(".item-qty");
        const priceInput = row.querySelector(".item-price");
        const amountSpan = row.querySelector(".item-amount");

        const qty = parseFloat(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const amount = qty * price;

        amountSpan.textContent = format3(amount);
    }

    function recalcTotals() {
        const rows = document.querySelectorAll("#invoice-items-table tbody tr");
        let subtotal = 0;

        rows.forEach(row => {
            const amountSpan = row.querySelector(".item-amount");
            const amount = parseFloat(amountSpan.textContent) || 0;
            subtotal += amount;
        });

        const vat = subtotal * 0.05;
        const total = subtotal + vat;

        document.getElementById("subtotal-value").textContent = format3(subtotal);
        document.getElementById("vat-value").textContent = format3(vat);
        document.getElementById("total-value").textContent = format3(total);
    }

    function bindRow(row) {
    if (row.dataset.bound === "1") return;
    row.dataset.bound = "1";

    const select = row.querySelector(".item-select");
    const codeInput = row.querySelector(".item-code");
    const descInput = row.querySelector(".item-desc");
    const unitInput = row.querySelector(".item-unit");
    const qtyInput = row.querySelector(".item-qty");
    const priceInput = row.querySelector(".item-price");

    select.addEventListener("change", () => {
        const code = select.value;
        if (warehouseItems[code]) {
            const item = warehouseItems[code];
            codeInput.value = item.code || "";
            descInput.value = item.description || item.name || "";
            unitInput.value = item.unitLabel || "";
            if (Number(priceInput.value || "0") === 0) {
                priceInput.value = item.price || "0";
            }
        } else {
            // clear when nothing selected
            codeInput.value = "";
            descInput.value = "";
            unitInput.value = "";
            priceInput.value = "0";
        }
        recalcRow(row);
        recalcTotals();
    });

    [qtyInput, priceInput].forEach(input => {
        input.addEventListener("input", () => {
            recalcRow(row);
            recalcTotals();
        });
    });
}

function attachEvents() {
    document.querySelectorAll("#invoice-items-table tbody tr").forEach(bindRow);
}

function renumberRows() {
    const rows = document.querySelectorAll("#invoice-items-table tbody tr");
    rows.forEach((row, i) => {
        const noCell = row.querySelector("td");
        if (noCell) noCell.textContent = String(i + 1);
    });
}

const addBtn = document.getElementById("add-item-row");
if (addBtn) {
    addBtn.addEventListener("click", () => {
        const tbody = document.querySelector("#invoice-items-table tbody");
        const lastRow = tbody.querySelector("tr:last-child");
        const newRow = lastRow.cloneNode(true);

        // clear inputs/selects
        newRow.querySelectorAll("select").forEach(s => s.value = "");
        newRow.querySelectorAll("input").forEach(inp => {
            if (inp.classList.contains("item-total")) {
                inp.value = "0.000";
            } else if (inp.classList.contains("item-price")) {
                inp.value = "0";
            } else {
                inp.value = "";
            }
        });

        tbody.appendChild(newRow);
        bindRow(newRow);
        renumberRows();
        recalcTotals();
    });
}

function printInvoice() {
        // ÿ¨ŸÑÿ® ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖŸÜ ÿßŸÑŸáŸäÿØÿ±
        const userNameElement = document.querySelector(".user-name");
        const userName = userNameElement ? userNameElement.textContent : "";

        // Ÿàÿ∂ÿπŸá ŸÅŸä ÿÆÿßŸÜÿ© ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        const printedBySpan = document.getElementById("printedBy");
        if (printedBySpan) {
            printedBySpan.textContent = userName;
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜÿµ ŸÇÿ®ŸÑ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        const footer = document.getElementById("print-footer");
        if (footer) {
            footer.style.display = "block";
        }

        // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
        window.print();

        // ÿ•ÿÆŸÅÿßÿ§Ÿá ÿ®ÿπÿØ ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿØÿßÿÆŸÑ ÿßŸÑŸÖŸàŸÇÿπ
        if (footer) {
            footer.style.display = "none";
        }
    }

    attachEvents();
    recalcTotals();
</script>
{% endblock %}
